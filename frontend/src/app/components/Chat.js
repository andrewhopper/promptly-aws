"use strict";
'use client';
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = __importStar(require("react"));
const react_chat_elements_1 = require("react-chat-elements");
require("react-chat-elements/dist/main.css");
const aws_amplify_1 = require("aws-amplify");
const VoiceChat_1 = require("./VoiceChat");
// Configure Amplify
aws_amplify_1.Amplify.configure({
    API: {
        REST: {
            'BedrockAgent': {
                endpoint: process.env.NEXT_PUBLIC_API_ENDPOINT || '',
                region: process.env.NEXT_PUBLIC_AWS_REGION || 'us-east-1'
            }
        }
    }
});
const Chat = () => {
    const [messages, setMessages] = (0, react_1.useState)([]);
    const [inputText, setInputText] = (0, react_1.useState)('');
    const [isLoading, setIsLoading] = (0, react_1.useState)(false);
    const [error, setError] = (0, react_1.useState)(null);
    const messageListRef = (0, react_1.useRef)(null);
    const [speakText, setSpeakText] = (0, react_1.useState)(null);
    const scrollToBottom = () => {
        const chatContainer = document.querySelector('.message-list');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    };
    (0, react_1.useEffect)(() => {
        scrollToBottom();
    }, [messages]);
    const addMessage = (message) => {
        setMessages(prev => [...prev, message]);
    };
    const createMessage = (text, position, status) => {
        return {
            position,
            type: 'text',
            title: position === 'left' ? 'Bedrock Agent' : 'You',
            text,
            date: new Date(),
            id: Date.now().toString(),
            status,
            focus: false,
            forwarded: false,
            replyButton: false,
            removeButton: false,
            notch: true,
            retracted: false,
            titleColor: position === 'left' ? '#4080ff' : '#40a9ff'
        };
    };
    const sendMessage = async (message) => {
        if (!message.trim() || isLoading)
            return;
        setIsLoading(true);
        setError(null);
        // Add user message
        const userMessage = createMessage(message, 'right', 'sent');
        addMessage(userMessage);
        setInputText('');
        // Add typing indicator
        const typingMessage = createMessage('Agent is typing...', 'left', 'waiting');
        addMessage(typingMessage);
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message }),
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            // Remove typing indicator
            setMessages(prev => prev.filter(msg => msg.status !== 'waiting'));
            // Add agent response
            const agentMessage = createMessage(data.response, 'left', 'received');
            addMessage(agentMessage);
            // Speak the response if speech synthesis is available
            if (speakText) {
                await speakText(data.response);
            }
        }
        catch (error) {
            console.error('Error sending message:', error);
            setError('Failed to send message. Please try again.');
            // Remove typing indicator
            setMessages(prev => prev.filter(msg => msg.status !== 'waiting'));
            // Add error message
            const errorMessage = createMessage('Sorry, there was an error processing your message.', 'left', 'received');
            addMessage(errorMessage);
        }
        finally {
            setIsLoading(false);
        }
    };
    return (<div className="flex flex-col h-full bg-gray-100 dark:bg-gray-900">
      <div className="p-4 bg-white dark:bg-gray-800 shadow-sm">
        <h1 className="text-2xl font-semibold text-gray-800 dark:text-gray-200">AWS Modules Chat</h1>
      </div>

      <div className="flex-grow overflow-auto p-4">
        <react_chat_elements_1.MessageList className="message-list" lockable={true} toBottomHeight={'100%'} dataSource={messages.map((msg) => ({
            type: 'text',
            position: msg.position,
            title: msg.title,
            text: msg.text,
            date: msg.date.getTime(),
            id: msg.id,
            status: msg.status,
            focus: msg.focus ?? false,
            forwarded: msg.forwarded ?? false,
            replyButton: msg.replyButton ?? false,
            removeButton: msg.removeButton ?? false,
            notch: msg.notch ?? true,
            retracted: msg.retracted ?? false,
            titleColor: msg.titleColor ?? (msg.position === 'left' ? '#4080ff' : '#40a9ff')
        }))} referance={messageListRef}/>
        {error && (<div className="text-red-500 text-sm mt-2 px-4">
            {error}
          </div>)}
      </div>

      <VoiceChat_1.VoiceChat onCheckIn={async (message) => {
            await sendMessage(message);
        }} onAgentResponse={(speak) => setSpeakText(() => speak)}/>

      <div className="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
        <div className="flex gap-2">
          <div className="flex-grow">
            <input type="text" placeholder="Type your message..." value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyPress={(e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(inputText);
            }
        }} disabled={isLoading} className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600"/>
          </div>
          <button onClick={() => sendMessage(inputText)} disabled={isLoading || !inputText.trim()} className={`px-6 py-2 rounded-lg font-medium ${isLoading || !inputText.trim()
            ? 'bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400'
            : 'bg-blue-500 text-white hover:bg-blue-600 dark:hover:bg-blue-700'}`}>
            {isLoading ? 'Sending...' : 'Send'}
          </button>
        </div>
      </div>
    </div>);
};
exports.default = Chat;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNoYXQudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxZQUFZLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFYiwrQ0FBMkQ7QUFDM0QsNkRBQWtEO0FBRWxELDZDQUEyQztBQUMzQyw2Q0FBc0M7QUFDdEMsMkNBQXdDO0FBRXhDLG9CQUFvQjtBQUNwQixxQkFBTyxDQUFDLFNBQVMsQ0FBQztJQUNoQixHQUFHLEVBQUU7UUFDSCxJQUFJLEVBQUU7WUFDSixjQUFjLEVBQUU7Z0JBQ2QsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLElBQUksRUFBRTtnQkFDcEQsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLElBQUksV0FBVzthQUMxRDtTQUNGO0tBQ0Y7Q0FDRixDQUFDLENBQUM7QUFtQkgsTUFBTSxJQUFJLEdBQWEsR0FBRyxFQUFFO0lBQzFCLE1BQU0sQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUFnQixFQUFFLENBQUMsQ0FBQztJQUM1RCxNQUFNLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBQyxFQUFFLENBQUMsQ0FBQztJQUMvQyxNQUFNLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBQyxLQUFLLENBQUMsQ0FBQztJQUNsRCxNQUFNLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBZ0IsSUFBSSxDQUFDLENBQUM7SUFDeEQsTUFBTSxjQUFjLEdBQUcsSUFBQSxjQUFNLEVBQWlCLElBQUksQ0FBQyxDQUFDO0lBQ3BELE1BQU0sQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUEyQyxJQUFJLENBQUMsQ0FBQztJQUUzRixNQUFNLGNBQWMsR0FBRyxHQUFHLEVBQUU7UUFD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QUFTLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FDekMsU0FBUyxDQUFDLENBQUMsb0NBQ1QsU0FBUyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRTtZQUM1QixDQUFDLENBQUMsK0RBQStEO1lBQ2pFLENBQUMsQ0FBQyxpRUFDTixFQUFFLENBQUMsQ0FFSDtZQUFBLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FDcEM7VUFBQSxFQUFFLE1BQU0sQ0FDVjtRQUFBLEVBQUUsR0FBRyxDQUNQO01BQUEsRUFBRSxHQUFHLENBQ1A7SUFBQSxFQUFFLEdBQUcsQ0FBQyxDQUNQLENBQUM7QUFDSixDQUFDLENBQUE7QUFFRCxrQkFBZSxJQUFJLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGNsaWVudCc7XG5cbmltcG9ydCBSZWFjdCwgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VSZWYgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBNZXNzYWdlTGlzdCB9IGZyb20gJ3JlYWN0LWNoYXQtZWxlbWVudHMnO1xuaW1wb3J0IHR5cGUgeyBNZXNzYWdlVHlwZSB9IGZyb20gJ3JlYWN0LWNoYXQtZWxlbWVudHMnO1xuaW1wb3J0ICdyZWFjdC1jaGF0LWVsZW1lbnRzL2Rpc3QvbWFpbi5jc3MnO1xuaW1wb3J0IHsgQW1wbGlmeSB9IGZyb20gJ2F3cy1hbXBsaWZ5JztcbmltcG9ydCB7IFZvaWNlQ2hhdCB9IGZyb20gJy4vVm9pY2VDaGF0JztcblxuLy8gQ29uZmlndXJlIEFtcGxpZnlcbkFtcGxpZnkuY29uZmlndXJlKHtcbiAgQVBJOiB7XG4gICAgUkVTVDoge1xuICAgICAgJ0JlZHJvY2tBZ2VudCc6IHtcbiAgICAgICAgZW5kcG9pbnQ6IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX0FQSV9FTkRQT0lOVCB8fCAnJyxcbiAgICAgICAgcmVnaW9uOiBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19BV1NfUkVHSU9OIHx8ICd1cy1lYXN0LTEnXG4gICAgICB9XG4gICAgfVxuICB9XG59KTtcblxuaW50ZXJmYWNlIENoYXRNZXNzYWdlIHtcbiAgcG9zaXRpb246ICdsZWZ0JyB8ICdyaWdodCc7XG4gIHR5cGU6ICd0ZXh0JztcbiAgdGl0bGU6IHN0cmluZztcbiAgdGV4dDogc3RyaW5nO1xuICBkYXRlOiBEYXRlO1xuICBpZDogc3RyaW5nO1xuICBzdGF0dXM6ICd3YWl0aW5nJyB8ICdzZW50JyB8ICdyZWNlaXZlZCcgfCAncmVhZCc7XG4gIGZvY3VzPzogYm9vbGVhbjtcbiAgZm9yd2FyZGVkPzogYm9vbGVhbjtcbiAgcmVwbHlCdXR0b24/OiBib29sZWFuO1xuICByZW1vdmVCdXR0b24/OiBib29sZWFuO1xuICBub3RjaD86IGJvb2xlYW47XG4gIHJldHJhY3RlZD86IGJvb2xlYW47XG4gIHRpdGxlQ29sb3I/OiBzdHJpbmc7XG59XG5cbmNvbnN0IENoYXQ6IFJlYWN0LkZDID0gKCkgPT4ge1xuICBjb25zdCBbbWVzc2FnZXMsIHNldE1lc3NhZ2VzXSA9IHVzZVN0YXRlPENoYXRNZXNzYWdlW10+KFtdKTtcbiAgY29uc3QgW2lucHV0VGV4dCwgc2V0SW5wdXRUZXh0XSA9IHVzZVN0YXRlKCcnKTtcbiAgY29uc3QgW2lzTG9hZGluZywgc2V0SXNMb2FkaW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcbiAgY29uc3QgW2Vycm9yLCBzZXRFcnJvcl0gPSB1c2VTdGF0ZTxzdHJpbmcgfCBudWxsPihudWxsKTtcbiAgY29uc3QgbWVzc2FnZUxpc3RSZWYgPSB1c2VSZWY8SFRNTERpdkVsZW1lbnQ+KG51bGwpO1xuICBjb25zdCBbc3BlYWtUZXh0LCBzZXRTcGVha1RleHRdID0gdXNlU3RhdGU8KCh0ZXh0OiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4pIHwgbnVsbD4obnVsbCk7XG5cbiAgY29uc3Qgc2Nyb2xsVG9Cb3R0b20gPSAoKSA9PiB7XG4gICAgY29uc3QgY2hhdENvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tZXNzYWdlLWxpc3QnKTtcbiAgICBpZiAoY2hhdENvbnRhaW5lcikge1xuICAgICAgY2hhdENvbnRhaW5lci5zY3JvbGxUb3AgPSBjaGF0Q29udGFpbmVyLnNjcm9sbEhlaWdodDtcbiAgICB9XG4gIH07XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBzY3JvbGxUb0JvdHRvbSgpO1xuICB9LCBbbWVzc2FnZXNdKTtcblxuICBjb25zdCBhZGRNZXNzYWdlID0gKG1lc3NhZ2U6IENoYXRNZXNzYWdlKSA9PiB7XG4gICAgc2V0TWVzc2FnZXMocHJldiA9PiBbLi4ucHJldiwgbWVzc2FnZV0pO1xuICB9O1xuXG4gIGNvbnN0IGNyZWF0ZU1lc3NhZ2UgPSAodGV4dDogc3RyaW5nLCBwb3NpdGlvbjogJ2xlZnQnIHwgJ3JpZ2h0Jywgc3RhdHVzOiBDaGF0TWVzc2FnZVsnc3RhdHVzJ10pOiBDaGF0TWVzc2FnZSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBvc2l0aW9uLFxuICAgICAgdHlwZTogJ3RleHQnLFxuICAgICAgdGl0bGU6IHBvc2l0aW9uID09PSAnbGVmdCcgPyAnQmVkcm9jayBBZ2VudCcgOiAnWW91JyxcbiAgICAgIHRleHQsXG4gICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgaWQ6IERhdGUubm93KCkudG9TdHJpbmcoKSxcbiAgICAgIHN0YXR1cyxcbiAgICAgIGZvY3VzOiBmYWxzZSxcbiAgICAgIGZvcndhcmRlZDogZmFsc2UsXG4gICAgICByZXBseUJ1dHRvbjogZmFsc2UsXG4gICAgICByZW1vdmVCdXR0b246IGZhbHNlLFxuICAgICAgbm90Y2g6IHRydWUsXG4gICAgICByZXRyYWN0ZWQ6IGZhbHNlLFxuICAgICAgdGl0bGVDb2xvcjogcG9zaXRpb24gPT09ICdsZWZ0JyA/ICcjNDA4MGZmJyA6ICcjNDBhOWZmJ1xuICAgIH07XG4gIH07XG5cbiAgY29uc3Qgc2VuZE1lc3NhZ2UgPSBhc3luYyAobWVzc2FnZTogc3RyaW5nKSA9PiB7XG4gICAgaWYgKCFtZXNzYWdlLnRyaW0oKSB8fCBpc0xvYWRpbmcpIHJldHVybjtcblxuICAgIHNldElzTG9hZGluZyh0cnVlKTtcbiAgICBzZXRFcnJvcihudWxsKTtcblxuICAgIC8vIEFkZCB1c2VyIG1lc3NhZ2VcbiAgICBjb25zdCB1c2VyTWVzc2FnZSA9IGNyZWF0ZU1lc3NhZ2UobWVzc2FnZSwgJ3JpZ2h0JywgJ3NlbnQnKTtcbiAgICBhZGRNZXNzYWdlKHVzZXJNZXNzYWdlKTtcbiAgICBzZXRJbnB1dFRleHQoJycpO1xuXG4gICAgLy8gQWRkIHR5cGluZyBpbmRpY2F0b3JcbiAgICBjb25zdCB0eXBpbmdNZXNzYWdlID0gY3JlYXRlTWVzc2FnZSgnQWdlbnQgaXMgdHlwaW5nLi4uJywgJ2xlZnQnLCAnd2FpdGluZycpO1xuICAgIGFkZE1lc3NhZ2UodHlwaW5nTWVzc2FnZSk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnL2FwaS9jaGF0Jywge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZSB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSFRUUCBlcnJvciEgc3RhdHVzOiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcblxuICAgICAgLy8gUmVtb3ZlIHR5cGluZyBpbmRpY2F0b3JcbiAgICAgIHNldE1lc3NhZ2VzKHByZXYgPT4gcHJldi5maWx0ZXIobXNnID0+IG1zZy5zdGF0dXMgIT09ICd3YWl0aW5nJykpO1xuXG4gICAgICAvLyBBZGQgYWdlbnQgcmVzcG9uc2VcbiAgICAgIGNvbnN0IGFnZW50TWVzc2FnZSA9IGNyZWF0ZU1lc3NhZ2UoZGF0YS5yZXNwb25zZSwgJ2xlZnQnLCAncmVjZWl2ZWQnKTtcbiAgICAgIGFkZE1lc3NhZ2UoYWdlbnRNZXNzYWdlKTtcblxuICAgICAgLy8gU3BlYWsgdGhlIHJlc3BvbnNlIGlmIHNwZWVjaCBzeW50aGVzaXMgaXMgYXZhaWxhYmxlXG4gICAgICBpZiAoc3BlYWtUZXh0KSB7XG4gICAgICAgIGF3YWl0IHNwZWFrVGV4dChkYXRhLnJlc3BvbnNlKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igc2VuZGluZyBtZXNzYWdlOicsIGVycm9yKTtcbiAgICAgIHNldEVycm9yKCdGYWlsZWQgdG8gc2VuZCBtZXNzYWdlLiBQbGVhc2UgdHJ5IGFnYWluLicpO1xuXG4gICAgICAvLyBSZW1vdmUgdHlwaW5nIGluZGljYXRvclxuICAgICAgc2V0TWVzc2FnZXMocHJldiA9PiBwcmV2LmZpbHRlcihtc2cgPT4gbXNnLnN0YXR1cyAhPT0gJ3dhaXRpbmcnKSk7XG5cbiAgICAgIC8vIEFkZCBlcnJvciBtZXNzYWdlXG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBjcmVhdGVNZXNzYWdlKFxuICAgICAgICAnU29ycnksIHRoZXJlIHdhcyBhbiBlcnJvciBwcm9jZXNzaW5nIHlvdXIgbWVzc2FnZS4nLFxuICAgICAgICAnbGVmdCcsXG4gICAgICAgICdyZWNlaXZlZCdcbiAgICAgICk7XG4gICAgICBhZGRNZXNzYWdlKGVycm9yTWVzc2FnZSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNldElzTG9hZGluZyhmYWxzZSk7XG4gICAgfVxuICB9O1xuXG4gIHJldHVybiAoXG4gICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGZsZXgtY29sIGgtZnVsbCBiZy1ncmF5LTEwMCBkYXJrOmJnLWdyYXktOTAwXCI+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cInAtNCBiZy13aGl0ZSBkYXJrOmJnLWdyYXktODAwIHNoYWRvdy1zbVwiPlxuICAgICAgICA8aDEgY2xhc3NOYW1lPVwidGV4dC0yeGwgZm9udC1zZW1pYm9sZCB0ZXh0LWdyYXktODAwIGRhcms6dGV4dC1ncmF5LTIwMFwiPkFXUyBNb2R1bGVzIENoYXQ8L2gxPlxuICAgICAgPC9kaXY+XG5cbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZmxleC1ncm93IG92ZXJmbG93LWF1dG8gcC00XCI+XG4gICAgICAgIDxNZXNzYWdlTGlzdFxuICAgICAgICAgIGNsYXNzTmFtZT1cIm1lc3NhZ2UtbGlzdFwiXG4gICAgICAgICAgbG9ja2FibGU9e3RydWV9XG4gICAgICAgICAgdG9Cb3R0b21IZWlnaHQ9eycxMDAlJ31cbiAgICAgICAgICBkYXRhU291cmNlPXttZXNzYWdlcy5tYXAoKG1zZyk6IE1lc3NhZ2VUeXBlID0+ICh7XG4gICAgICAgICAgICB0eXBlOiAndGV4dCcsXG4gICAgICAgICAgICBwb3NpdGlvbjogbXNnLnBvc2l0aW9uLFxuICAgICAgICAgICAgdGl0bGU6IG1zZy50aXRsZSxcbiAgICAgICAgICAgIHRleHQ6IG1zZy50ZXh0LFxuICAgICAgICAgICAgZGF0ZTogbXNnLmRhdGUuZ2V0VGltZSgpLFxuICAgICAgICAgICAgaWQ6IG1zZy5pZCxcbiAgICAgICAgICAgIHN0YXR1czogbXNnLnN0YXR1cyxcbiAgICAgICAgICAgIGZvY3VzOiBtc2cuZm9jdXMgPz8gZmFsc2UsXG4gICAgICAgICAgICBmb3J3YXJkZWQ6IG1zZy5mb3J3YXJkZWQgPz8gZmFsc2UsXG4gICAgICAgICAgICByZXBseUJ1dHRvbjogbXNnLnJlcGx5QnV0dG9uID8/IGZhbHNlLFxuICAgICAgICAgICAgcmVtb3ZlQnV0dG9uOiBtc2cucmVtb3ZlQnV0dG9uID8/IGZhbHNlLFxuICAgICAgICAgICAgbm90Y2g6IG1zZy5ub3RjaCA/PyB0cnVlLFxuICAgICAgICAgICAgcmV0cmFjdGVkOiBtc2cucmV0cmFjdGVkID8/IGZhbHNlLFxuICAgICAgICAgICAgdGl0bGVDb2xvcjogbXNnLnRpdGxlQ29sb3IgPz8gKG1zZy5wb3NpdGlvbiA9PT0gJ2xlZnQnID8gJyM0MDgwZmYnIDogJyM0MGE5ZmYnKVxuICAgICAgICAgIH0pKX1cbiAgICAgICAgICByZWZlcmFuY2U9e21lc3NhZ2VMaXN0UmVmfVxuICAgICAgICAvPlxuICAgICAgICB7ZXJyb3IgJiYgKFxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwidGV4dC1yZWQtNTAwIHRleHQtc20gbXQtMiBweC00XCI+XG4gICAgICAgICAgICB7ZXJyb3J9XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cblxuICAgICAgPFZvaWNlQ2hhdFxuICAgICAgICBvbkNoZWNrSW49e2FzeW5jIChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgYXdhaXQgc2VuZE1lc3NhZ2UobWVzc2FnZSk7XG4gICAgICAgIH19XG4gICAgICAgIG9uQWdlbnRSZXNwb25zZT17KHNwZWFrKSA9PiBzZXRTcGVha1RleHQoKCkgPT4gc3BlYWspfVxuICAgICAgLz5cblxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJwLTQgYmctd2hpdGUgZGFyazpiZy1ncmF5LTgwMCBib3JkZXItdCBib3JkZXItZ3JheS0yMDAgZGFyazpib3JkZXItZ3JheS03MDBcIj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGdhcC0yXCI+XG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4LWdyb3dcIj5cbiAgICAgICAgICAgIDxpbnB1dFxuICAgICAgICAgICAgICB0eXBlPVwidGV4dFwiXG4gICAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwiVHlwZSB5b3VyIG1lc3NhZ2UuLi5cIlxuICAgICAgICAgICAgICB2YWx1ZT17aW5wdXRUZXh0fVxuICAgICAgICAgICAgICBvbkNoYW5nZT17KGUpID0+IHNldElucHV0VGV4dChlLnRhcmdldC52YWx1ZSl9XG4gICAgICAgICAgICAgIG9uS2V5UHJlc3M9eyhlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGUua2V5ID09PSAnRW50ZXInICYmICFlLnNoaWZ0S2V5KSB7XG4gICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICBzZW5kTWVzc2FnZShpbnB1dFRleHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgZGlzYWJsZWQ9e2lzTG9hZGluZ31cbiAgICAgICAgICAgICAgY2xhc3NOYW1lPVwidy1mdWxsIHB4LTQgcHktMiBib3JkZXIgcm91bmRlZC1sZyBmb2N1czpvdXRsaW5lLW5vbmUgZm9jdXM6cmluZy0yIGZvY3VzOnJpbmctYmx1ZS01MDAgYmctd2hpdGUgZGFyazpiZy1ncmF5LTcwMCB0ZXh0LWdyYXktOTAwIGRhcms6dGV4dC1ncmF5LTEwMCBib3JkZXItZ3JheS0zMDAgZGFyazpib3JkZXItZ3JheS02MDBcIlxuICAgICAgICAgICAgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiBzZW5kTWVzc2FnZShpbnB1dFRleHQpfVxuICAgICAgICAgICAgZGlzYWJsZWQ9e2lzTG9hZGluZyB8fCAhaW5wdXRUZXh0LnRyaW0oKX1cbiAgICAgICAgICAgIGNsYXNzTmFtZT17YHB4LTYgcHktMiByb3VuZGVkLWxnIGZvbnQtbWVkaXVtICR7XG4gICAgICAgICAgICAgIGlzTG9hZGluZyB8fCAhaW5wdXRUZXh0LnRyaW0oKVxuICAgICAgICAgICAgICAgID8gJ2JnLWdyYXktMzAwIGRhcms6YmctZ3JheS02MDAgdGV4dC1ncmF5LTUwMCBkYXJrOnRleHQtZ3JheS00MDAnXG4gICAgICAgICAgICAgICAgOiAnYmctYmx1ZS01MDAgdGV4dC13aGl0ZSBob3ZlcjpiZy1ibHVlLTYwMCBkYXJrOmhvdmVyOmJnLWJsdWUtNzAwJ1xuICAgICAgICAgICAgfWB9XG4gICAgICAgICAgPlxuICAgICAgICAgICAge2lzTG9hZGluZyA/ICdTZW5kaW5nLi4uJyA6ICdTZW5kJ31cbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2hhdDtcbiJdfQ==